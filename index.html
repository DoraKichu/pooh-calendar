<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç™¾ç•æ£®æ—ç­è¡¨</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/96/winnie-the-pooh.png">
    
    <!-- 1. æ¨£å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React æ ¸å¿ƒ -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        body { 
            -webkit-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; 
            background-color: #FFFBEB; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overscroll-behavior: none;
        }
        .sketchy-border { border: 2px solid #44403c; border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .modal-anim { animation: popIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .click-effect:active { transform: scale(0.95); transition: transform 0.1s; }
        .strike-through { text-decoration: line-through; opacity: 0.6; }
    </style>
</head>
<body>
    <div id="error-box" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; padding:20px; color:red; overflow:auto;"></div>
    <script>
        window.onerror = function(msg, url, line) {
            var box = document.getElementById('error-box');
            box.style.display = 'block';
            box.innerHTML += "<h3>ç™¼ç”ŸéŒ¯èª¤</h3><p>" + msg + "</p><p>Line: " + line + "</p>";
            var loader = document.getElementById('app-loader');
            if(loader) loader.style.display = 'none';
        };
    </script>

    <div id="app-loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#FFFBEB]">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-amber-400 border-t-amber-600 mb-4"></div>
        <div class="text-amber-800 font-bold text-lg">æ­£åœ¨å‘¼å«ç¶­å°¼...ğŸ¯</div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyBmSNgnmQ7LjOHE_9irjQ-OpzCp70S3xZE",
            authDomain: "v02457.firebaseapp.com",
            projectId: "v02457",
            storageBucket: "v02457.firebasestorage.app",
            messagingSenderId: "606551517368",
            appId: "1:606551517368:web:b6fbca7d61b42480982c4d"
        };

        const SYNC_ID = 'our_honey_calendar_v1';
        const STORAGE_KEY = 'pooh_db_final_v3';

        let auth = null, db = null;
        try {
            if (typeof firebase !== 'undefined' && !firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                db.enablePersistence({ synchronizeTabs: true }).catch(function(){});
            }
        } catch (e) {
            console.warn("Firebase Init Failed, using Offline Mode");
        }

        const IconChevronLeft = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>;
        const IconChevronRight = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>;
        const IconCopy = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2 M8 8h6v6"/></svg>;
        const IconLogOut = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
        const IconX = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>;
        const IconMapPin = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const IconSave = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const IconFileText = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>;
        const IconCheck = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconRotateCcw = () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/></svg>;
        const IconList = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>;

        const CuteSunCloud = () => (
            <svg viewBox="0 0 100 100" className="w-6 h-6 opacity-90 drop-shadow-sm">
                <filter id="glow"><feDropShadow dx="0" dy="1" stdDeviation="1" floodColor="#000" floodOpacity="0.1"/></filter>
                <g filter="url(#glow)">
                    <circle cx="75" cy="35" r="18" fill="#FDB813" />
                    <path d="M75 10v5M75 55v5M95 35h-5M55 35h5M89 21l-3 3M61 49l3-3M89 49l-3-3M61 21l3 3" stroke="#FDB813" strokeWidth="3" strokeLinecap="round"/>
                    <path d="M25 75c-15 0-20-20-5-30 0-15 25-25 40-10 15-5 30 10 25 25 10 10 0 20-15 20H25z" fill="#FFF" stroke="#BAE6FD" strokeWidth="2" strokeLinejoin="round"/>
                    <circle cx="40" cy="60" r="2.5" fill="#475569"/><circle cx="65" cy="60" r="2.5" fill="#475569"/><path d="M48 66q4.5 4 9 0" stroke="#475569" strokeWidth="2" strokeLinecap="round"/>
                    <ellipse cx="32" cy="64" rx="3" ry="2" fill="#F472B6" opacity="0.5"/><ellipse cx="73" cy="64" rx="3" ry="2" fill="#F472B6" opacity="0.5"/>
                </g>
            </svg>
        );

        const STICKERS = {
            WORK: { emoji: "ğŸ", label: "æ—©ç­", rotate: "-6deg" },
            OT: { emoji: "ğŸˆ", label: "åŠ ç­", rotate: "0deg" },
            LEAVE: { emoji: "ğŸƒ", label: "è«‹å‡", rotate: "0deg" },
            VACATION: { emoji: "âœˆï¸", label: "å‡ºåœ‹", rotate: "0deg" },
            TRIP: { emoji: "ğŸš˜", label: "å‡ºéŠ", rotate: "-3deg" },
            OFF: { emoji: "â˜ï¸", label: "ä¼‘å‡", rotate: "0deg" },
            BIRTHDAY: { emoji: "ğŸ‚", label: "ç”Ÿæ—¥", rotate: "0deg" }
        };

        const WEEKDAYS = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        const COUNTRY_FLAGS = {
            'æ—¥æœ¬': 'ğŸ‡¯ğŸ‡µ', 'äº¬é˜ª': 'ğŸ‡¯ğŸ‡µ', 'æ±äº¬': 'ğŸ‡¯ğŸ‡µ', 'å¤§é˜ª': 'ğŸ‡¯ğŸ‡µ', 'æ²–ç¹©': 'ğŸ‡¯ğŸ‡µ', 'åŒ—æµ·é“': 'ğŸ‡¯ğŸ‡µ',
            'éŸ“åœ‹': 'ğŸ‡°ğŸ‡·', 'é¦–çˆ¾': 'ğŸ‡°ğŸ‡·', 'é‡œå±±': 'ğŸ‡°ğŸ‡·',
            'ä¸­åœ‹': 'ğŸ‡¨ğŸ‡³', 'ä¸Šæµ·': 'ğŸ‡¨ğŸ‡³', 'åŒ—äº¬': 'ğŸ‡¨ğŸ‡³',
            'é¦™æ¸¯': 'ğŸ‡­ğŸ‡°', 'æ¾³é–€': 'ğŸ‡²ğŸ‡´', 'å°ç£': 'ğŸ‡¹ğŸ‡¼',
            'æ³°åœ‹': 'ğŸ‡¹ğŸ‡­', 'æ›¼è°·': 'ğŸ‡¹ğŸ‡­', 'æ¸…é‚': 'ğŸ‡¹ğŸ‡­',
            'è¶Šå—': 'ğŸ‡»ğŸ‡³', 'å³´æ¸¯': 'ğŸ‡»ğŸ‡³', 'æ²³å…§': 'ğŸ‡»ğŸ‡³',
            'æ–°åŠ å¡': 'ğŸ‡¸ğŸ‡¬', 'é¦¬ä¾†è¥¿äº': 'ğŸ‡²ğŸ‡¾', 'æ²™å·´': 'ğŸ‡²ğŸ‡¾',
            'è²å¾‹è³“': 'ğŸ‡µğŸ‡­', 'å®¿éœ§': 'ğŸ‡µğŸ‡­', 'é•·ç˜å³¶': 'ğŸ‡µğŸ‡­',
            'å°å°¼': 'ğŸ‡®ğŸ‡©', 'å³‡é‡Œå³¶': 'ğŸ‡®ğŸ‡©',
            'è‹±åœ‹': 'ğŸ‡¬ğŸ‡§', 'æ³•åœ‹': 'ğŸ‡«ğŸ‡·', 'å¾·åœ‹': 'ğŸ‡©ğŸ‡ª', 'ç¾©å¤§åˆ©': 'ğŸ‡®ğŸ‡¹', 'ç‘å£«': 'ğŸ‡¨ğŸ‡­', 'è·è˜­': 'ğŸ‡³ğŸ‡±',
            'ç¾åœ‹': 'ğŸ‡ºğŸ‡¸', 'é—œå³¶': 'ğŸ‡¬ğŸ‡º', 'å¤å¨å¤·': 'ğŸ‡ºğŸ‡¸', 'åŠ æ‹¿å¤§': 'ğŸ‡¨ğŸ‡¦', 'æ¾³æ´²': 'ğŸ‡¦ğŸ‡º', 'åœŸè€³å…¶': 'ğŸ‡¹ğŸ‡·'
        };

        const LONG_HOLIDAYS = [
            { start: '2025-01-01', end: '2025-01-01' }, { start: '2025-01-25', end: '2025-02-02' }, { start: '2025-02-28', end: '2025-03-02' },
            { start: '2025-04-03', end: '2025-04-06' }, { start: '2025-05-01', end: '2025-05-01' }, { start: '2025-05-30', end: '2025-06-01' },
            { start: '2025-09-27', end: '2025-09-29' }, { start: '2025-10-04', end: '2025-10-06' }, { start: '2025-10-10', end: '2025-10-12' },
            { start: '2025-10-24', end: '2025-10-26' }, { start: '2025-12-25', end: '2025-12-25' },
            { start: '2026-02-14', end: '2026-02-22' }, { start: '2026-02-27', end: '2026-03-01' }, { start: '2026-04-03', end: '2026-04-06' },
            { start: '2026-05-01', end: '2026-05-03' }, { start: '2026-06-19', end: '2026-06-21' }, { start: '2026-09-25', end: '2026-09-28' },
            { start: '2026-10-09', end: '2026-10-11' }, { start: '2026-10-24', end: '2026-10-26' }, { start: '2026-12-25', end: '2026-12-27' }
        ];

        const isLongHoliday = (dateStr) => LONG_HOLIDAYS.find(r => dateStr >= r.start && dateStr <= r.end);

        const HOLIDAYS = {
            '2025-01-01': 'å…ƒæ—¦', '2025-01-25': 'é™¤å¤•å‰', '2025-01-26': 'å°å¹´å¤œ', '2025-01-27': 'é™¤å¤•', '2025-01-28': 'æ˜¥ç¯€', '2025-01-29': 'æ˜¥ç¯€', '2025-01-30': 'æ˜¥ç¯€', '2025-01-31': 'æ˜¥ç¯€', '2025-02-01': 'æ˜¥ç¯€', '2025-02-02': 'æ˜¥ç¯€',
            '2025-02-28': '228', '2025-04-03': 'å…’ç«¥ç¯€', '2025-04-04': 'æ¸…æ˜ç¯€', '2025-05-01': 'å‹å‹•ç¯€', '2025-05-30': 'ç«¯åˆé€£', '2025-05-31': 'ç«¯åˆç¯€', '2025-09-28': 'æ•™å¸«ç¯€', '2025-10-06': 'ä¸­ç§‹ç¯€', '2025-10-10': 'åœ‹æ…¶æ—¥', '2025-10-25': 'å…‰å¾©ç¯€', '2025-12-25': 'è¡Œæ†²æ—¥',
            '2026-01-01': 'å…ƒæ—¦', '2026-02-14': 'æ˜¥ç¯€', '2026-02-15': 'æ˜¥ç¯€', '2026-02-16': 'é™¤å¤•', '2026-02-17': 'æ˜¥ç¯€', '2026-02-18': 'æ˜¥ç¯€', '2026-02-19': 'æ˜¥ç¯€', '2026-02-20': 'æ˜¥ç¯€', '2026-02-21': 'æ˜¥ç¯€', '2026-02-22': 'æ˜¥ç¯€',
            '2026-02-28': '228', '2026-04-04': 'å…’ç«¥ç¯€', '2026-04-05': 'æ¸…æ˜ç¯€', '2026-05-01': 'å‹å‹•ç¯€', '2026-06-19': 'ç«¯åˆç¯€', '2026-09-25': 'ä¸­ç§‹ç¯€', '2026-09-28': 'æ•™å¸«ç¯€', '2026-10-10': 'åœ‹æ…¶æ—¥', '2026-10-25': 'å…‰å¾©ç¯€', '2026-12-25': 'è¡Œæ†²æ—¥'
        };

        const getFlag = (txt) => {
            if(!txt) return null;
            for(const key in COUNTRY_FLAGS) {
                if(txt.includes(key)) return COUNTRY_FLAGS[key];
            }
            return null;
        }

        const fallbackCopy = (text) => {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try { document.execCommand('copy'); alert("âœ… å·²è¤‡è£½ï¼"); } 
            catch (e) { alert("è¤‡è£½å¤±æ•—"); }
            document.body.removeChild(textArea);
        };

        function App() {
            const [mods, setMods] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved).mods || {} : {};
                } catch(e) { return {}; }
            });

            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(null);
            const [tempDest, setTempDest] = useState('');
            const [tempNote, setTempNote] = useState('');
            const [isDone, setIsDone] = useState(false);
            const [exitConfirm, setExitConfirm] = useState(false);

            const touchRef = useRef({ start: null, end: null });

            useEffect(() => {
                const loader = document.getElementById('app-loader');
                if(loader) loader.style.display = 'none';
            }, []);

            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({ mods: mods }));
            }, [mods]);

            useEffect(() => {
                if(!auth) return;
                const unsubAuth = auth.onAuthStateChanged(async u => {
                    if (u) {
                        setUser(u);
                        if (db) {
                            try {
                                const unsubDoc = db.collection('calendars').doc(SYNC_ID).onSnapshot(doc => {
                                    if (doc.exists) {
                                        const data = doc.data().mods || {};
                                        setMods(data);
                                        localStorage.setItem(STORAGE_KEY, JSON.stringify({ mods: data }));
                                    }
                                }, err => console.log("Offline mode"));
                                return () => unsubDoc();
                            } catch(e) {}
                        }
                    } else {
                        try { await auth.signInAnonymously(); } catch(e){}
                    }
                    setLoading(false);
                });
                return () => unsubAuth();
            }, []);

            useEffect(() => {
                if (selectedDay) {
                    const data = mods[selectedDay.dateStr] || {};
                    setTempDest(data.destination || '');
                    setTempNote(data.note || '');
                    setIsDone(data.isDone || false);
                }
            }, [selectedDay]);

            // --- å¾…è¾¦äº‹é … (Upcoming) ---
            const upcomingEvents = useMemo(() => {
                const today = new Date(); 
                today.setHours(0,0,0,0);
                const events = [];
                for (const [key, val] of Object.entries(mods)) {
                    if (!val) continue;
                    // è§£ææ—¥æœŸå­—ä¸² YYYY-MM-DD
                    const parts = key.split('-');
                    if (parts.length === 3) {
                        const d = new Date(Number(parts[0]), Number(parts[1])-1, Number(parts[2]));
                        // æ¢ä»¶ï¼šæ˜¯æœªä¾†æ—¥æœŸ ä¸” (æœ‰å‚™è¨» OR æœ‰åœ°é» OR æ˜¯ç‰¹æ®Šè¡Œç¨‹)
                        if (d >= today && (val.note || val.destination || (val.type && val.type !== 'OFF' && val.type !== 'WORK'))) {
                            events.push({ date: d, dateStr: key, ...val });
                        }
                    }
                }
                // æ’åºä¸¦å–å‰ 5 ç­†
                return events.sort((a,b) => a.date - b.date).slice(0, 5);
            }, [mods]);

            const changeMonth = (d) => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + d)));

            const handleUpdate = async (type) => {
                if (!selectedDay) return;
                const dateStr = selectedDay.dateStr;
                const newMods = { ...mods };
                const existingData = newMods[dateStr] || {};

                if (type === 'RESET') {
                    const newData = { ...existingData, type: null, destination: tempDest, note: tempNote, isDone: isDone };
                    if (!newData.destination && !newData.note) delete newMods[dateStr];
                    else newMods[dateStr] = newData;
                } else if (type === 'SAVE_TEXT') {
                    const newData = { ...existingData, destination: tempDest, note: tempNote, isDone: isDone };
                    if (!newData.type && !newData.destination && !newData.note) delete newMods[dateStr];
                    else newMods[dateStr] = newData;
                } else {
                    newMods[dateStr] = { type: type, destination: tempDest, note: tempNote, isDone: isDone };
                }
                
                setMods(newMods);
                setSelectedDay(null);
                setTempDest('');
                setTempNote('');
                setIsDone(false);
                
                if (db && auth.currentUser) {
                    db.collection('calendars').doc(SYNC_ID).set({ mods: newMods }, { merge: true }).catch(()=>{});
                }
            };

            const handleExit = () => {
                if(exitConfirm) window.location.reload();
                else { setExitConfirm(true); setTimeout(()=>setExitConfirm(false), 3000); }
            };

            const copySchedule = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const daysInMonth = new Date(year, month, 0).getDate();
                let text = `${year}å¹´${month}æœˆ Bç­ç­è¡¨ ğŸ¯\n`;
                for(let i=1; i<=daysInMonth; i++) {
                    const dateObj = new Date(year, month-1, i);
                    const dateStr = `${year}-${String(month).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const diff = Math.round((dateObj - new Date(2025,0,1)) / (1000*60*60*24));
                    const baseWork = (((diff % 4) + 4) % 4) < 2;
                    const mod = mods[dateStr];
                    const type = mod ? mod.type : null;
                    
                    let icon = 'â˜ï¸';
                    if(type === 'LEAVE') icon = 'ğŸƒ';
                    else if(type === 'VACATION') icon = 'âœˆï¸';
                    else if(type === 'TRIP') icon = 'ğŸš˜';
                    else if(type === 'OT') icon = 'ğŸˆ';
                    else if(baseWork) icon = 'ğŸ';

                    let status = type ? STICKERS[type].label : (baseWork ? 'æ—©ç­' : 'ä¼‘å‡');
                    if(mod && mod.destination) status += ` (${mod.destination})`;
                    if(mod && mod.note) status += ` [${mod.note}]`;
                    text += `${month}/${i} (${WEEKDAYS[dateObj.getDay()]}): ${icon} ${status}\n`;
                }
                fallbackCopy(text);
            };

            const stats = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month+1, 0).getDate();
                let work=0, ot=0, leave=0;
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const diff = Math.round((new Date(year, month, i) - new Date(2025,0,1)) / (1000*60*60*24));
                    const baseWork = (((diff % 4) + 4) % 4) < 2;
                    const type = mods[dateStr] ? mods[dateStr].type : null;
                    if(type === 'OT') ot++;
                    else if(['LEAVE','VACATION','TRIP'].includes(type)) leave++;
                    else if(baseWork && type!=='RESET') work++;
                }
                return { work, ot, leave };
            }, [currentDate, mods]);

            const renderSticker = (config) => (
                <span className="text-lg filter drop-shadow-sm transition-transform inline-block" style={{transform: `rotate(${config.rotate})`}}>{config.emoji}</span>
            );

            const onTouchStart = e => { touchRef.current.start = e.targetTouches[0].clientX; touchRef.current.end = null; };
            const onTouchMove = e => touchRef.current.end = e.targetTouches[0].clientX;
            const onTouchEnd = () => {
                const { start, end } = touchRef.current;
                if (!start || !end) return;
                const diff = start - end;
                if (diff > 50) changeMonth(1); else if (diff < -50) changeMonth(-1);
            };

            const renderDays = () => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = new Date(year, month+1, 0).getDate();
                const startDay = new Date(year, month, 1).getDay();
                const days = [];

                for(let i=0; i<startDay; i++) days.push(<div key={`p${i}`} className="h-[5.2rem] m-0.5 bg-amber-50/30 border border-amber-100/50 rounded-xl backdrop-blur-sm"></div>);

                for(let i=1; i<=daysInMonth; i++) {
                    const dateObj = new Date(year, month, i);
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const diff = Math.round((dateObj - new Date(2025,0,1)) / (1000*60*60*24));
                    const baseWork = (((diff % 4) + 4) % 4) < 2;

                    const mod = mods[dateStr];
                    const type = mod ? mod.type : null;
                    const hasNote = mod && mod.note && mod.note.trim().length > 0;
                    const holiday = HOLIDAYS[dateStr];
                    const isLong = isLongHoliday(dateStr);
                    const isWeekend = dateObj.getDay()===0 || dateObj.getDay()===6;
                    const isBirthday = (month===0 && i===22) || (month===7 && i===14);
                    const flag = mod ? getFlag(mod.destination) : null;
                    const isToday = new Date().toDateString() === dateObj.toDateString();

                    let bg='bg-white', border='border-stone-200';
                    if (type === 'OT') { bg='bg-[#FEE2E2]'; border='border-[#F87171]'; }
                    else if (type === 'LEAVE') { bg='bg-[#ECFCCB]'; border='border-[#BEF264]'; }
                    else if (type === 'VACATION') { bg='bg-[#FCE7F3]'; border='border-[#F9A8D4]'; }
                    else if (type === 'TRIP') { bg='bg-[#E0F2FE]'; border='border-[#7DD3FC]'; }
                    else if (isLong) { bg='bg-[#E0F2FE]'; border='border-sky-200'; }
                    else if (isWeekend) { bg='bg-[#FFF1F2]'; border='border-stone-200'; }
                    else if (!type && baseWork) { bg='bg-[#FEF9C3]'; border='border-[#FDE047]'; }

                    let display = <span className="text-sm font-black text-stone-400">{i}</span>;
                    if (flag) display = <span className="text-2xl filter drop-shadow-sm">{flag}</span>;
                    else if (mod && mod.destination) display = <span className="text-[11px] font-black text-indigo-600 truncate max-w-[42px] -rotate-2 block leading-tight">{mod.destination}</span>;
                    else if (holiday) display = <span className="text-[12px] font-black text-[#E11D48] -rotate-3 block leading-tight">{holiday}</span>;
                    else if (isBirthday) display = <span className="text-xl text-rose-500">â¤ï¸</span>;

                    let sticker;
                    if (isBirthday && !type) sticker = <span className="text-xl animate-bounce inline-block">ğŸ‚</span>;
                    else if (type) {
                        const s = STICKERS[type];
                        sticker = s ? renderSticker(s) : null;
                    } else if (baseWork) {
                        sticker = renderSticker(STICKERS.WORK);
                    } else {
                        sticker = <CuteSunCloud />;
                    }

                    days.push(
                        <div 
                            key={i} 
                            onClick={() => setSelectedDay({dateStr, baseWork})} 
                            className={`h-[5.2rem] p-1 border-2 ${border} ${bg} rounded-2xl relative active:scale-95 transition-all overflow-hidden shadow-sm ${isToday?'ring-2 ring-amber-400 animate-pulse':''} sketchy-border click-effect`}
                        >
                            <div className="flex flex-col items-center justify-between h-full py-0.5 relative z-10 pointer-events-none">
                                <div className="h-6 flex items-center justify-center w-full">{display}</div>
                                <div className={`flex items-center justify-center -mt-1 pb-1 ${isToday?'animate-bounce':''}`}>{sticker}</div>
                            </div>
                            {hasNote && (
                                <div className="absolute bottom-1 right-1 pointer-events-none">
                                    <IconFileText className="w-3 h-3 text-stone-400 note-dot" />
                                </div>
                            )}
                        </div>
                    );
                }
                return days;
            };

            if (loading) return null;

            return (
                <div className="max-w-[480px] mx-auto h-screen flex flex-col bg-[#FFFBEB] font-sans shadow-2xl relative" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
                    <div className="bg-[#FDE047] p-5 z-20 rounded-b-[30px] border-b-4 border-[#FCD34D] shadow-sm">
                        <div className="flex justify-between items-center mb-4">
                             <h1 className="text-2xl font-black text-[#78350F] tracking-wide flex items-center gap-2"><span className="text-3xl drop-shadow-md">ğŸ»</span>ç™¾ç•æ£®æ—ç­è¡¨</h1>
                             <div className="flex gap-1">
                                <button onClick={copySchedule} className="p-3 bg-white/40 rounded-full text-[#78350F] active:scale-90 border-2 border-[#78350F]/10"><IconCopy className="w-5 h-5"/></button>
                                <button onClick={handleExit} className={`${exitConfirm?'bg-[#EF4444] animate-pulse':'bg-[#F87171]'} p-3 rounded-full text-white active:scale-90 border-2 border-[#B91C1C]/10`}>{exitConfirm?<IconX className="w-5 h-5"/>:<IconLogOut className="w-5 h-5"/>}</button>
                             </div>
                        </div>
                        <div className="flex justify-between items-center px-2">
                            <button onClick={()=>changeMonth(-1)} className="p-2 text-[#78350F] active:scale-90"><IconChevronLeft /></button>
                            <div className="text-xl font-black text-[#78350F] bg-white/50 px-6 py-2 rounded-2xl border-2 border-white shadow-inner sketchy-border">
                                {currentDate.getFullYear()} <span className="text-[#78350F]/40 mx-1">/</span> {currentDate.getMonth()+1}æœˆ
                            </div>
                            <button onClick={()=>changeMonth(1)} className="p-2 text-[#78350F] active:scale-90"><IconChevronRight /></button>
                        </div>
                        
                        {/* ğŸŒŸ æ¥ä¸‹ä¾†çš„è¡Œç¨‹ ğŸŒŸ */}
                        <div className="flex justify-start gap-3 mt-4 overflow-x-auto no-scrollbar pb-2 px-1">
                            {upcomingEvents.length > 0 ? upcomingEvents.map((ev) => {
                                const d = ev.date;
                                let content = ev.note || ev.destination || (STICKERS[ev.type] ? STICKERS[ev.type].label : '');
                                return (
                                    <div key={ev.dateStr} className={`flex-shrink-0 bg-white/60 p-2 rounded-xl border-2 border-white/50 min-w-[90px] shadow-sm sketchy-border ${ev.isDone ? 'opacity-50' : ''}`}>
                                        <div className="text-[10px] font-bold text-amber-500 mb-0.5">{d.getMonth()+1}/{d.getDate()} ({WEEKDAYS[d.getDay()]})</div>
                                        <div className={`text-xs font-black text-[#78350F] truncate w-20 ${ev.isDone ? 'strike-through' : ''}`}>
                                            <span className="mr-1">{ev.type === 'VACATION' || ev.destination ? 'âœˆï¸' : 'ğŸ“'}</span>
                                            {content}
                                        </div>
                                    </div>
                                )
                            }) : (
                                <div className="text-xs text-[#78350F] opacity-50 font-bold px-2 py-2">ğŸ“… æ¥ä¸‹ä¾†æ²’æœ‰è¡Œç¨‹å–”~</div>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-2 no-scrollbar">
                        <div className="grid grid-cols-7 mb-2 text-center font-black text-[#92400E] text-sm">
                            {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map((d,i)=><div key={d} className={i===0||i===6?'text-[#F43F5E]':''}>{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-0 pb-20">
                            {renderDays()}
                        </div>
                    </div>

                    {selectedDay && (
                        <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4 modal-anim" onClick={()=>setSelectedDay(null)}>
                            <div className="bg-[#FFFBEB] w-full max-w-[360px] rounded-[30px] border-4 border-[#FDE047] overflow-hidden shadow-2xl sketchy-border" onClick={e=>e.stopPropagation()}>
                                <div className="bg-[#FDE047] p-4 text-center border-b-2 border-[#FCD34D] flex justify-between items-center px-6">
                                    <h3 className="text-2xl font-black text-[#78350F]">ç·¨è¼¯è¡Œç¨‹ ğŸ¯</h3>
                                    <button onClick={()=>handleUpdate('SAVE_TEXT')} className="bg-white/40 p-2 rounded-full text-[#78350F] active:scale-95 border-2 border-[#78350F]/20">
                                        <IconSave className="w-5 h-5"/>
                                    </button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div className="relative">
                                        <div className="absolute left-4 top-3 text-[#F59E0B]"><IconMapPin className="w-5 h-5"/></div>
                                        <input type="text" value={tempDest} onChange={e=>setTempDest(e.target.value)} placeholder="åœ°é» (å¦‚: æ—¥æœ¬)..." className="w-full pl-12 pr-4 py-3 rounded-xl border-2 border-[#FDE047] focus:outline-none font-bold text-[#78350F] placeholder-[#FCD34D] sketchy-border" />
                                        {getFlag(tempDest) && <div className="absolute right-4 top-2 text-2xl animate-bounce">{getFlag(tempDest)}</div>}
                                    </div>

                                    <div className="relative">
                                        <div className="absolute left-4 top-3 text-[#F59E0B]"><IconFileText className="w-5 h-5"/></div>
                                        <textarea value={tempNote} onChange={e=>setTempNote(e.target.value)} placeholder="ä»£è¾¦äº‹é … (ä¾‹å¦‚: 10é»é–‹æœƒ)..." className={`w-full pl-12 pr-12 py-3 rounded-xl border-2 border-[#FDE047] focus:outline-none font-bold text-[#78350F] placeholder-[#FCD34D] sketchy-border resize-none h-20 ${isDone?'strike-through':''}`}></textarea>
                                        <button onClick={()=>setIsDone(!isDone)} className={`absolute right-3 top-3 p-1.5 rounded-full border-2 transition-all active:scale-90 ${isDone ? 'bg-green-500 border-green-600 text-white' : 'bg-white border-stone-300 text-stone-300'}`}>
                                            <IconCheck className="w-4 h-4" />
                                        </button>
                                    </div>
                                    
                                    {selectedDay.baseWork ? (
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={()=>handleUpdate('LEAVE')} className="bg-[#ECFCCB] p-4 rounded-2xl border-2 border-[#BEF264] text-[#4D7C0F] font-bold active:scale-95 sketchy-border">ğŸƒ è«‹å‡</button>
                                            <button onClick={()=>handleUpdate('TRIP')} className="bg-[#E0F2FE] p-4 rounded-2xl border-2 border-[#7DD3FC] text-[#0369A1] font-bold active:scale-95 sketchy-border">ğŸš˜ å‡ºéŠ</button>
                                            <button onClick={()=>handleUpdate('VACATION')} className="col-span-2 bg-[#FCE7F3] p-4 rounded-2xl border-2 border-[#F9A8D4] text-[#BE185D] font-bold active:scale-95 sketchy-border">âœˆï¸ å‡ºåœ‹</button>
                                            <button onClick={()=>handleUpdate('RESET')} className="col-span-2 bg-stone-100 p-4 rounded-2xl border-2 border-stone-200 text-stone-500 font-bold active:scale-95 sketchy-border">ğŸ æ¢å¾©ä¸Šç­</button>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={()=>handleUpdate('OT')} className="bg-[#FEE2E2] p-4 rounded-2xl border-2 border-[#F87171] text-[#B91C1C] font-bold active:scale-95 sketchy-border">ğŸˆ åŠ ç­</button>
                                            <button onClick={()=>handleUpdate('TRIP')} className="bg-[#E0F2FE] p-4 rounded-2xl border-2 border-[#7DD3FC] text-[#0369A1] font-bold active:scale-95 sketchy-border">ğŸš˜ å‡ºéŠ</button>
                                            <button onClick={()=>handleUpdate('VACATION')} className="col-span-2 bg-[#FCE7F3] p-4 rounded-2xl border-2 border-[#F9A8D4] text-[#BE185D] font-bold active:scale-95 sketchy-border">âœˆï¸ å‡ºåœ‹</button>
                                            <button onClick={()=>handleUpdate('RESET')} className="col-span-2 bg-stone-100 p-4 rounded-2xl border-2 border-stone-200 text-stone-500 font-bold active:scale-95 sketchy-border">â˜ï¸ æ¢å¾©ä¼‘å‡</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
